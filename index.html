<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NTMA - Khảo sát hàm số & Tương giao (Full + Fullscreen)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        body { background-color: #f3f4f6; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        #print-area { position: fixed; left: -9999px; top: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-animate { animation: fadeIn 0.2s ease-out forwards; }
        /* Style cho thanh trượt */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #d97706; cursor: pointer; margin-top: -6px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #e5e7eb; border-radius: 2px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;

        // --- ICONS ---
        const IconBase = ({ children, className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>);
        const Settings = (p) => <IconBase {...p}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></IconBase>;
        const List = (p) => <IconBase {...p}><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></IconBase>;
        const Calculator = (p) => <IconBase {...p}><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="16" y1="14" x2="16" y2="14"/><line x1="16" y1="18" x2="16" y2="18"/><line x1="12" y1="14" x2="12" y2="14"/><line x1="12" y1="18" x2="12" y2="18"/><line x1="8" y1="14" x2="8" y2="14"/><line x1="8" y1="18" x2="8" y2="18"/></IconBase>;
        const Bot = (p) => <IconBase {...p}><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/></IconBase>;
        const Info = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></IconBase>;
        const Palette = (p) => <IconBase {...p}><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></IconBase>;
        const Layers = (p) => <IconBase {...p}><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></IconBase>;
        const CheckCircle2 = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></IconBase>;
        const XCircle = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></IconBase>;
        const AlertTriangle = (p) => <IconBase {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>;
        const Eye = (p) => <IconBase {...p}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const EyeOff = (p) => <IconBase {...p}><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7c.44 0 .87-.03 1.28-.09"/><line x1="2" y1="2" x2="22" y2="22"/></IconBase>;
        const ZoomIn = (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></IconBase>;
        const ZoomOut = (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></IconBase>;
        const ChevronRight = (p) => <IconBase {...p}><polyline points="9 18 15 12 9 6"/></IconBase>;
        const Grid = (p) => <IconBase {...p}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></IconBase>;
        const ArrowUpRight = (p) => <IconBase {...p}><line x1="7" y1="17" x2="17" y2="7"/><polyline points="7 7 17 7 17 17"/></IconBase>;
        const RotateCcw = (p) => <IconBase {...p}><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></IconBase>;
        const QuestionIcon = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></IconBase>;
        const ShieldCheck = (p) => <IconBase {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></IconBase>;
        const Download = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconBase>;
        const HelpCircle = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></IconBase>;
        const Split = (p) => <IconBase {...p}><path d="M16 3h5v5"/><path d="M8 3H3v5"/><path d="M12 22v-8.3a4 4 0 0 0-1.172-2.872L3 3"/><path d="m15 9 6-6"/></IconBase>;
        // --- NEW ICONS FOR FULLSCREEN ---
        const Maximize = (p) => <IconBase {...p}><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/></IconBase>;
        const Minimize = (p) => <IconBase {...p}><path d="M8 3v3a2 2 0 0 1-2 2H3"/><path d="M21 8h-3a2 2 0 0 1-2-2V3"/><path d="M3 16h3a2 2 0 0 1 2 2v3"/><path d="M16 21v-3a2 2 0 0 1 2-2h3"/></IconBase>;

        // --- CẤU HÌNH ---
        const FONT_FAMILY = "'Times New Roman', Times, serif";
        const MATH_FONT_FAMILY = "'Times New Roman', Times, serif";
        const DEFAULT_BLUE = '#1e3a8a'; 
        const COLORS = [{ hex: '#1e3a8a' }, { hex: '#dc2626' }, { hex: '#16a34a' }, { hex: '#9333ea' }, { hex: '#000000' }];

        // --- LOGIC TOÁN ---
        const formatNum = (n) => { if (n==undefined||!isFinite(n)) return ''; if(Math.abs(n)<1e-10) return '0'; let s=Number.isInteger(n)?n.toString():(Math.round(n*100)/100).toString(); return s.replace('-','−'); };
        const solveQuadratic = (A,B,C) => { if(Math.abs(A)<1e-10){if(Math.abs(B)<1e-10)return[];return[-C/B];} const d=B*B-4*A*C; if(d<0)return[]; if(Math.abs(d)<1e-10)return[-B/(2*A)]; const s=Math.sqrt(d); return [(-B-s)/(2*A),(-B+s)/(2*A)].sort((a,b)=>a-b); };

        const getFunctionValue = (x, funcType, coeffs) => {
            const { a, b, c, d, e } = coeffs;
            if (funcType === 'cubic') return a * x * x * x + b * x * x + c * x + d;
            if (funcType === 'quadratic') return a * x * x + b * x + c;
            if (funcType === 'quartic') return a * x * x * x * x + b * x * x + c;
            if (funcType === 'rational11') return (a * x + b) / (c * x + d);
            if (funcType === 'rational21') return (a * x * x + b * x + c) / (d * x + e);
            if (funcType === 'trig') return a * Math.sin(b * x + c) + d;
            if (funcType === 'trig_cos') return a * Math.cos(b * x + c) + d;
            if (funcType === 'trig_tan') return a * Math.tan(b * x + c) + d;
            if (funcType === 'trig_cot') return a * (1 / Math.tan(b * x + c)) + d;
            if (funcType === 'logarithmic') { if (x + c <= 0) return NaN; return a * (Math.log(x + c) / Math.log(b)) + d; }
            if (funcType === 'exponential') return a * Math.pow(b, x + c) + d;
            return 0;
        }

        const MathFormula = ({ type, a, b, c, d, e, fontSize }) => {
          const Term = ({ coef, power, first=false }) => {
            if (Math.abs(coef) < 1e-9) return null;
            let sign = ''; let val = Math.abs(coef);
            if (!first) sign = coef > 0 ? ' + ' : ' − '; else if (coef < 0) sign = '−';
            let valStr = val === 1 && power > 0 ? '' : formatNum(val).replace('-', '');
            return <span>{sign}{valStr}{power > 0 && <i>x</i>}{power > 1 && <sup style={{fontSize: '0.7em'}}>{power}</sup>}</span>;
          };
          const style = { fontFamily: MATH_FONT_FAMILY, fontSize: `${fontSize}pt`, color: DEFAULT_BLUE };
          if (type === 'cubic') return <div style={style} className="font-bold"><i>y</i> = <Term coef={a} power={3} first={true} /><Term coef={b} power={2} /><Term coef={c} power={1} /><Term coef={d} power={0} /></div>;
          if (type === 'quadratic') return <div style={style} className="font-bold"><i>y</i> = <Term coef={a} power={2} first={true} /><Term coef={b} power={1} /><Term coef={c} power={0} /></div>;
          if (type === 'quartic') return <div style={style} className="font-bold"><i>y</i> = <Term coef={a} power={4} first={true} /><Term coef={b} power={2} /><Term coef={c} power={0} /></div>;
          if (type === 'rational11') return <div style={style} className="font-bold flex items-center gap-1"><i>y</i> = <div className="flex flex-col items-center justify-center mx-1"><div className="border-b-2 border-blue-900 px-1 pb-[1px] mb-[1px]"><Term coef={a} power={1} first={true} /><Term coef={b} power={0} /></div><div className="px-1"><Term coef={c} power={1} first={true} /><Term coef={d} power={0} /></div></div></div>;
          if (type === 'rational21') return <div style={style} className="font-bold flex items-center gap-1"><i>y</i> = <div className="flex flex-col items-center justify-center mx-1"><div className="border-b-2 border-blue-900 px-1 pb-[1px] mb-[1px]"><Term coef={a} power={2} first={true} /><Term coef={b} power={1} /><Term coef={c} power={0} /></div><div className="px-1"><Term coef={d} power={1} first={true} /><Term coef={e} power={0} /></div></div></div>;
          if (type === 'trig') return <div style={style} className="font-bold"><i>y</i> = {formatNum(a) === '1' ? '' : (formatNum(a) === '-1' ? '−' : formatNum(a))}sin({formatNum(b)}<i>x</i> {c >= 0 ? '+' : '−'} {formatNum(Math.abs(c))}) {d !== 0 ? (d > 0 ? '+ ' + formatNum(d) : '− ' + formatNum(Math.abs(d))) : ''}</div>;
          if (type === 'trig_cos') return <div style={style} className="font-bold"><i>y</i> = {formatNum(a) === '1' ? '' : (formatNum(a) === '-1' ? '−' : formatNum(a))}cos({formatNum(b)}<i>x</i> {c >= 0 ? '+' : '−'} {formatNum(Math.abs(c))}) {d !== 0 ? (d > 0 ? '+ ' + formatNum(d) : '− ' + formatNum(Math.abs(d))) : ''}</div>;
          if (type === 'trig_tan') return <div style={style} className="font-bold"><i>y</i> = {formatNum(a) === '1' ? '' : (formatNum(a) === '-1' ? '−' : formatNum(a))}tan({formatNum(b)}<i>x</i> {c >= 0 ? '+' : '−'} {formatNum(Math.abs(c))}) {d !== 0 ? (d > 0 ? '+ ' + formatNum(d) : '− ' + formatNum(Math.abs(d))) : ''}</div>;
          if (type === 'trig_cot') return <div style={style} className="font-bold"><i>y</i> = {formatNum(a) === '1' ? '' : (formatNum(a) === '-1' ? '−' : formatNum(a))}cot({formatNum(b)}<i>x</i> {c >= 0 ? '+' : '−'} {formatNum(Math.abs(c))}) {d !== 0 ? (d > 0 ? '+ ' + formatNum(d) : '− ' + formatNum(Math.abs(d))) : ''}</div>;
          if (type === 'logarithmic') return <div style={style} className="font-bold"><i>y</i> = {formatNum(a)==='1'?'':(formatNum(a)==='-1'?'−':formatNum(a))}log<sub>{formatNum(b)}</sub>(<i>x</i> {c>=0?'+':'−'} {formatNum(Math.abs(c))}) {d!==0?(d>0?'+ '+formatNum(d):'− '+formatNum(Math.abs(d))):''}</div>;
          if (type === 'exponential') return <div style={style} className="font-bold"><i>y</i> = {formatNum(a)==='1'?'':(formatNum(a)==='-1'?'−':formatNum(a))}{formatNum(b)}<sup><i>x</i> {c>=0?'+':'−'} {formatNum(Math.abs(c))}</sup> {d!==0?(d>0?'+ '+formatNum(d):'− '+formatNum(Math.abs(d))):''}</div>;
          return null;
        };

        const SocraticTutor = ({ funcType, coeffs, analysis, onToggleResults }) => {
          const [step, setStep] = useState(0); const [subStep, setSubStep] = useState(0); const [hintLevel, setHintLevel] = useState(0); 
          const [userAnswer, setUserAnswer] = useState(''); const [feedback, setFeedback] = useState(null); const [showWhy, setShowWhy] = useState(false); const [isCorrect, setIsCorrect] = useState(false);
          useEffect(() => { setStep(0); setSubStep(0); setHintLevel(0); setUserAnswer(''); setFeedback(null); setIsCorrect(false); setShowWhy(false); }, [funcType, coeffs]);
          if (!analysis || !analysis.valid) return null;
          const getStepContent = () => {
            let q = "", h1 = "", h2 = "", h3 = "", why = "";
            if (step === 0) {
              if (['rational11', 'rational21'].includes(funcType)) { const val = funcType === 'rational11' ? -coeffs.d/coeffs.c : -coeffs.e/coeffs.d; q = "Bước 1: Tập xác định. Em hãy tìm giá trị x mà hàm số KHÔNG xác định."; h1 = "Hàm phân thức xác định khi mẫu số khác 0."; h2 = `Hãy giải phương trình mẫu số = 0 để tìm nghiệm.`; h3 = `Mẫu số bằng 0 khi x = ${formatNum(val)}.`; why = "Vì phép chia cho 0 không xác định trong tập số thực, nên ta phải loại bỏ giá trị làm mẫu bằng 0."; }
              else if (['cubic', 'quartic', 'quadratic', 'exponential', 'trig', 'trig_cos', 'trig_tan', 'trig_cot'].includes(funcType)) { q = "Bước 1: Tập xác định của hàm số này là gì?"; h1 = "Có điều kiện gì cho x không? (Căn thức, mẫu số...)"; h2 = "Hàm đa thức xác định với mọi giá trị x."; h3 = "Tập xác định là R (toàn bộ trục số)."; why = "Các phép toán cộng, trừ, nhân, lũy thừa luôn thực hiện được với mọi số thực."; }
              else if (funcType === 'logarithmic') { const val = -coeffs.c; q = "Bước 1: Điều kiện xác định của hàm logarit này là gì?"; h1 = "Biểu thức bên trong logarit phải luôn dương."; h2 = `Giải bất phương trình: x ${coeffs.c >= 0 ? '+' : '−'} ${formatNum(Math.abs(coeffs.c))} > 0.`; h3 = `x phải lớn hơn ${formatNum(val)}.`; why = "Hàm logarit log_b(u) chỉ có nghĩa khi u > 0."; }
            } else if (step === 1) {
              q = "Bước 2: Xét sự biến thiên. Đạo hàm y' có các nghiệm nào? (Liệt kê đủ)";
              if (['rational11'].includes(funcType)) { q = "Bước 2: Xét dấu y'. Hàm số này Đồng biến hay Nghịch biến?"; h1 = "Tính y' và xem dấu của tử số."; h2 = `Tử số của y' là (ad - bc).`; h3 = analysis.yPrimeNum > 0 ? "Tử số dương -> Đồng biến." : "Tử số âm -> Nghịch biến."; why = "Nếu y' > 0 trên miền K thì hàm đồng biến trên K. Ngược lại y' < 0 thì nghịch biến."; }
              else { h1 = "Tính y' theo công thức đạo hàm cơ bản, sau đó giải y' = 0."; h2 = "Nghiệm của y' là các điểm cực trị tiềm năng."; const roots = analysis.roots || []; h3 = roots.length > 0 ? `y' = 0 tại x ∈ {${roots.map(r => formatNum(r)).join(', ')}}` : "y' = 0 vô nghiệm."; why = "Đạo hàm y' cho biết tốc độ thay đổi tức thời. Tại các điểm y' = 0, đồ thị có tiếp tuyến nằm ngang (thường là cực trị)."; }
            } else if (step === 2) { const numExtrema = analysis.extrema.length; q = `Bước 3: Hàm số có bao nhiêu điểm cực trị?`; h1 = "Dựa vào số nghiệm đơn của phương trình y' = 0."; h2 = "Nếu y' đổi dấu qua nghiệm thì đó là cực trị."; h3 = `Hàm số này có ${numExtrema} cực trị.`; why = "Cực trị là các điểm 'đỉnh núi' (cực đại) hoặc 'đáy thung lũng' (cực tiểu) của đồ thị."; }
            else if (step === 3) {
              if (funcType === 'rational11') { if (subStep === 0) { q = "Bước 4a: Tìm Tiệm cận đứng. Đường thẳng x = ?"; h1 = "Tiệm cận đứng là nghiệm của mẫu số."; h2 = `Giải phương trình mẫu số ${formatNum(coeffs.c)}x + ${formatNum(coeffs.d)} = 0.`; h3 = `x = ${formatNum(-coeffs.d/coeffs.c)}.`; why = "Khi x tiến dần tới nghiệm của mẫu, giá trị hàm số tiến ra vô cực."; } else { q = "Bước 4b: Tìm Tiệm cận ngang. Đường thẳng y = ?"; h1 = "Tiệm cận ngang là giới hạn của hàm số khi x -> vô cùng."; h2 = "Với hàm bậc 1/1, TCN là tỉ số hai hệ số của x trên tử và mẫu (a/c)."; h3 = `y = a/c = ${formatNum(coeffs.a/coeffs.c)}.`; why = "Khi x rất lớn, các hằng số không đáng kể, y xấp xỉ ax/cx = a/c."; } } 
              else if (funcType === 'rational21') { if (subStep === 0) { q = "Bước 4a: Tìm Tiệm cận đứng. Đường thẳng x = ?"; h1 = "Tiệm cận đứng là nghiệm của mẫu số."; h2 = `Giải phương trình mẫu số ${formatNum(coeffs.d)}x + ${formatNum(coeffs.e)} = 0.`; h3 = `x = ${formatNum(-coeffs.e/coeffs.d)}.`; why = "Khi x tiến dần tới nghiệm của mẫu, giá trị hàm số tiến ra vô cực."; } else { q = "Bước 4b: Tìm Tiệm cận xiên. Đường thẳng y = ax + b. Nhập phương trình hoặc các hệ số."; h1 = "Thực hiện phép chia đa thức tử cho mẫu."; h2 = "Thương số của phép chia chính là phương trình tiệm cận xiên."; const m = coeffs.a / coeffs.d; const k = (coeffs.b * coeffs.d - coeffs.a * coeffs.e) / (coeffs.d * coeffs.d); h3 = `y = ${formatNum(m)}x ${k>=0?'+':''} ${formatNum(k)}.`; why = "Khi x -> vô cùng, phần dư của phép chia tiến về 0, đồ thị tiệm cận đường thẳng thương."; } }
              else if (funcType === 'logarithmic') { q = "Bước 4: Hàm Logarit có tiệm cận đứng x = ?"; h1 = "Xét tại biên của tập xác định."; h2 = "Biểu thức trong logarit bằng 0 tại đâu?"; h3 = `x = ${formatNum(-coeffs.c)}.`; why = "Logarit tiến tới vô cực khi biểu thức bên trong tiến về 0."; }
              else if (funcType === 'exponential') { q = "Bước 4: Hàm Mũ có tiệm cận ngang y = ?"; h1 = "Xét giới hạn khi x -> âm vô cùng (nếu cơ số > 1) hoặc dương vô cùng."; h2 = "Phần mũ tiến về 0, hàm số còn lại hằng số nào?"; h3 = `y = ${formatNum(coeffs.d)}.`; why = "Hàm mũ b^x luôn dương và tiến về 0 ở một đầu vô cực, nên đồ thị tiệm cận đường nằm ngang."; }
              else { q = "Bước 4: Hàm số này có đường tiệm cận nào không?"; h1 = "Hàm đa thức bậc cao có tiệm cận không?"; h2 = "Khi x -> vô cùng, y cũng -> vô cùng."; h3 = "Không có tiệm cận."; why = "Hàm đa thức liên tục trên R và nhánh vô hạn, không bị chặn bởi đường thẳng nào."; }
            } else { q = "Chúc mừng! Em đã hoàn thành việc khảo sát."; }
            return { q, h1, h2, h3, why };
          };
          const content = getStepContent();
          const handleCheckAnswer = () => {
            const extractNums = (str) => { const matches = str.match(/-?\d+(\.\d+)?(\/\d+)?/g); if (!matches) return []; return matches.map(s => { if (s.includes('/')) { const [n, d] = s.split('/'); return parseFloat(n) / parseFloat(d); } return parseFloat(s); }); };
            const input = userAnswer.toLowerCase().trim(); const userNums = extractNums(input);
            let correct = false; let feedbackType = 'error'; let errorMsg = "Câu trả lời chưa chính xác. Thử lại nhé!";
            if (step === 0) { 
               if (['rational11', 'rational21'].includes(funcType)) { const val = funcType === 'rational11' ? -coeffs.d/coeffs.c : -coeffs.e/coeffs.d; if (userNums.some(n => Math.abs(n - val) < 0.01)) correct = true; else errorMsg = "Em hãy kiểm tra lại nghiệm của mẫu số."; }
               else if (funcType === 'logarithmic') { const val = -coeffs.c; if (userNums.some(n => Math.abs(n - val) < 0.01)) correct = true; else errorMsg = "Em hãy kiểm tra lại điều kiện biểu thức trong logarit > 0."; }
               else { if (input.includes('r') || input.includes('thực') || input.includes('mọi')) correct = true; else errorMsg = "Hàm đa thức/lượng giác/mũ thường xác định trên đâu?"; }
            } else if (step === 1) { 
                if (funcType === 'rational11') { const isInc = analysis.yPrimeNum > 0; if ((isInc && (input.includes('đồng') || input.includes('tăng') || input.includes('>'))) || (!isInc && (input.includes('nghịch') || input.includes('giảm') || input.includes('<')))) { correct = true; } else { errorMsg = "Hãy tính kỹ dấu của tử số (ad - bc)."; } }
                else { const roots = analysis.roots || []; if (roots.length === 0) { if (input.includes('vô') || input.includes('không')) correct = true; else errorMsg = "Phương trình y' = 0 có nghiệm không? Hãy kiểm tra lại."; } else { const foundCount = roots.filter(r => userNums.some(u => Math.abs(u - r) < 0.1)).length; if (foundCount === roots.length) { correct = true; } else if (foundCount > 0) { feedbackType = 'warning'; errorMsg = `Em đã tìm đúng ${foundCount} nghiệm, nhưng vẫn còn thiếu (tổng ${roots.length} nghiệm).`; } else { errorMsg = "Chưa thấy nghiệm đúng nào của y'."; } } }
            } else if (step === 2) { const num = analysis.extrema.length; if (input.includes(num.toString())) correct = true; else errorMsg = "Số lượng điểm cực trị chưa đúng."; } 
            else if (step === 3) { 
                if (funcType === 'rational11') { if (subStep === 0) { const val = -coeffs.d / coeffs.c; if (userNums.some(n => Math.abs(n - val) < 0.01)) correct = true; else errorMsg = "Giá trị x chưa đúng. Kiểm tra nghiệm mẫu số."; } else { const val = coeffs.a / coeffs.c; if (userNums.some(n => Math.abs(n - val) < 0.01)) correct = true; else errorMsg = "Giá trị y chưa đúng. Kiểm tra tỉ số hệ số bậc cao nhất."; } }
                else if (funcType === 'rational21') { if (subStep === 0) { const val = -coeffs.e / coeffs.d; if (userNums.some(n => Math.abs(n - val) < 0.01)) correct = true; else errorMsg = "Giá trị x chưa đúng. Kiểm tra nghiệm mẫu số."; } else { const m = coeffs.a / coeffs.d; const k = (coeffs.b * coeffs.d - coeffs.a * coeffs.e) / (coeffs.d * coeffs.d); const hasM = userNums.some(n => Math.abs(n - m) < 0.01); const hasK = userNums.some(n => Math.abs(n - k) < 0.01); if (hasM && (hasK || Math.abs(k) < 0.01)) correct = true; else if (hasM) { feedbackType = 'warning'; errorMsg = "Hệ số góc a đúng, nhưng hệ số tự do b chưa đúng."; } else if (hasK) { feedbackType = 'warning'; errorMsg = "Hệ số tự do b đúng, nhưng hệ số góc a chưa đúng."; } else errorMsg = "Phương trình tiệm cận xiên chưa chính xác."; } }
                else if (['logarithmic', 'exponential'].includes(funcType)) { const asymVals = analysis.asymptotes.map(a => a.val); if (asymVals.some(val => userNums.some(u => Math.abs(u - val) < 0.1))) correct = true; else errorMsg = "Giá trị tiệm cận chưa chính xác."; }
                else { if (input.includes('không') || input.includes('0')) correct = true; else errorMsg = "Hàm đa thức này không có tiệm cận."; }
            }
            if (correct) { setFeedback({ type: 'success', msg: 'Chính xác! Em làm tốt lắm.' }); setIsCorrect(true); } 
            else { setFeedback({ type: feedbackType, msg: errorMsg }); setIsCorrect(false); }
          };
          const handleNext = () => { let nextStep = step; let nextSubStep = subStep; if (step === 3 && ['rational11', 'rational21'].includes(funcType) && subStep === 0) { nextSubStep = 1; } else { nextStep = step + 1; nextSubStep = 0; } setStep(nextStep); setSubStep(nextSubStep); setHintLevel(0); setUserAnswer(''); setFeedback(null); setIsCorrect(false); setShowWhy(false); };
          if (step > 3) return (<div className="bg-green-50 rounded-xl shadow border-2 border-green-200 p-6 text-center min-h-[350px] flex flex-col items-center justify-center" style={{ fontFamily: FONT_FAMILY }}><CheckCircle2 className="w-16 h-16 text-green-500 mb-4" /><h3 className="text-xl font-bold text-green-800 mb-2">Hoàn thành xuất sắc!</h3><p className="text-green-700 mb-4">Em đã nắm vững các bước khảo sát hàm số này.</p><button onClick={() => { setStep(0); setSubStep(0); }} className="flex items-center px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-bold shadow"><RotateCcw className="w-4 h-4 mr-2"/> Làm lại</button></div>);
          return (
            <div className="bg-amber-50 rounded-xl shadow border-2 border-amber-200 overflow-hidden flex flex-col mb-4 min-h-[350px]" style={{ fontFamily: FONT_FAMILY }}>
              <div className="bg-amber-100 px-4 py-3 flex items-center justify-between border-b border-amber-200"><div className="flex items-center text-amber-800 font-bold text-lg"><Bot className="w-6 h-6 mr-2" /><span>Trợ giảng AI – Socrates</span></div><div className="text-xs font-semibold text-amber-700 bg-amber-200 px-2 py-1 rounded">{step === 3 && ['rational11', 'rational21'].includes(funcType) ? `Bước 4${subStep===0?'a':'b'}` : `Bước ${step + 1}`}/4</div></div>
              <div className="p-5 flex-1 flex flex-col">
                <div className="bg-white p-4 rounded-lg border border-amber-200 shadow-sm text-blue-900 text-lg mb-4 leading-relaxed"><p className="font-bold mb-3">{content.q}</p><div className="flex gap-2 mb-2"><input type="text" value={userAnswer} onChange={(e) => setUserAnswer(e.target.value)} placeholder="Nhập câu trả lời (VD: 1, 2...)" className="flex-1 border-2 border-gray-300 rounded px-3 py-2 text-base focus:border-blue-500 focus:outline-none" onKeyDown={(e) => e.key === 'Enter' && handleCheckAnswer()} disabled={isCorrect}/><button onClick={handleCheckAnswer} disabled={!userAnswer || isCorrect} className={`px-4 py-2 rounded font-bold text-white transition-colors ${!userAnswer || isCorrect ? 'bg-gray-400' : 'bg-blue-600 hover:bg-blue-700'}`}>Kiểm tra</button></div>{feedback && (<div className={`p-3 rounded border-l-4 text-base animate-in fade-in slide-in-from-top-2 mb-2 ${feedback.type === 'success' ? 'bg-green-50 border-green-500 text-green-800' : (feedback.type === 'warning' ? 'bg-yellow-50 border-yellow-500 text-yellow-800' : 'bg-red-50 border-red-500 text-red-800')}`}><div className="flex items-center font-bold">{feedback.type === 'success' ? "Đúng rồi!" : (feedback.type === 'warning' ? "Gần đúng!" : "Chưa chính xác")}</div><div>{feedback.msg}</div></div>)}{hintLevel > 0 && (<div className="mt-3 space-y-2">{hintLevel >= 1 && <div className="text-base text-gray-700 bg-gray-50 p-2 rounded border-l-4 border-green-400"><span className="font-bold text-green-700">Gợi ý 1 (Nhẹ):</span> {content.h1}</div>}{hintLevel >= 2 && <div className="text-base text-gray-700 bg-gray-50 p-2 rounded border-l-4 border-yellow-400"><span className="font-bold text-yellow-700">Gợi ý 2 (Vừa):</span> {content.h2}</div>}{hintLevel >= 3 && <div className="text-base text-gray-700 bg-gray-50 p-2 rounded border-l-4 border-red-400"><span className="font-bold text-red-700">Gợi ý 3 (Sát sườn):</span> {content.h3}</div>}</div>)}{showWhy && (<div className="mt-3 p-3 bg-indigo-50 border border-indigo-200 rounded text-indigo-900 text-base italic animate-in fade-in"><span className="font-bold not-italic"><QuestionIcon className="w-4 h-4 inline mr-1"/>Giải thích:</span> {content.why}</div>)}</div>
                <div className="mt-auto space-y-3">{!isCorrect && (<div className="flex flex-wrap gap-2"><button onClick={() => setHintLevel(1)} className={`flex-1 py-2 rounded font-bold text-sm border ${hintLevel===1 ? 'bg-green-100 border-green-300 text-green-800' : 'bg-white border-gray-300 hover:bg-gray-50 text-gray-600'}`}>Gợi ý 1</button><button onClick={() => setHintLevel(2)} className={`flex-1 py-2 rounded font-bold text-sm border ${hintLevel===2 ? 'bg-yellow-100 border-yellow-300 text-yellow-800' : 'bg-white border-gray-300 hover:bg-gray-50 text-gray-600'}`}>Gợi ý 2</button><button onClick={() => setHintLevel(3)} className={`flex-1 py-2 rounded font-bold text-sm border ${hintLevel===3 ? 'bg-red-100 border-red-300 text-red-800' : 'bg-white border-gray-300 hover:bg-gray-50 text-gray-600'}`}>Gợi ý 3</button><button onClick={() => setShowWhy(!showWhy)} className="px-3 py-2 rounded font-bold text-sm border bg-indigo-50 border-indigo-200 text-indigo-700 hover:bg-indigo-100" title="Tại sao?"><QuestionIcon className="w-5 h-5"/></button></div>)}{isCorrect && (<button onClick={handleNext} className="w-full flex items-center justify-center px-4 py-3 bg-amber-500 text-white rounded-lg font-bold text-lg hover:bg-amber-600 transition-colors shadow-md animate-bounce">Tiếp theo <ChevronRight className="w-5 h-5 ml-1" /></button>)}</div>
              </div>
            </div>
          );
        };

        const AnalysisResults = ({ analysis, funcType, coeffs }) => {
            if (!analysis || !analysis.valid) return <div className="text-gray-500 italic">Chưa có dữ liệu phân tích</div>;
            const { a, b, c, d, e } = coeffs;
            const Term = ({ coef, power, first=false }) => { if (Math.abs(coef) < 1e-9) return null; let sign = ''; let val = Math.abs(coef); if (!first) sign = coef > 0 ? ' + ' : ' − '; else if (coef < 0) sign = '−'; let valStr = val === 1 && power > 0 ? '' : formatNum(val).replace('-', ''); return <span>{sign}{valStr}{power > 0 && <i>x</i>}{power > 1 && <sup>{power}</sup>}</span>; };
            let domainStr = "", derivDisplay = null, extremaStr = [], asymStr = [];
            if (funcType === 'cubic') { domainStr = <span>D = ℝ</span>; derivDisplay = <span>y' = <Term coef={3*a} power={2} first={true} /><Term coef={2*b} power={1} /><Term coef={c} power={0} /></span>; }
            else if (funcType === 'rational11') { domainStr = <span>D = ℝ \ {'{'}{formatNum(-d/c)}{'}'}</span>; const num = a*d - b*c; derivDisplay = <div className="flex items-center gap-1">y' = <div className="flex flex-col items-center justify-center"><div className="border-b border-black px-1">{formatNum(num)}</div><div>(<Term coef={c} power={1} first={true} /><Term coef={d} power={0} />)<sup>2</sup></div></div></div>; }
            else if (funcType === 'rational21') { domainStr = <span>D = ℝ \ {'{'}{formatNum(-e/d)}{'}'}</span>; const A = a*d; const B = 2*a*e; const C = b*e - c*d; derivDisplay = <div className="flex items-center gap-1">y' = <div className="flex flex-col items-center justify-center"><div className="border-b border-black px-1"><Term coef={A} power={2} first={true} /><Term coef={B} power={1} /><Term coef={C} power={0} /></div><div>(<Term coef={d} power={1} first={true} /><Term coef={e} power={0} />)<sup>2</sup></div></div></div>; }
            if (analysis.extrema.length === 0) extremaStr.push("Hàm số không có cực trị"); else { analysis.extrema.forEach((ex, idx) => { extremaStr.push(<div key={idx} className="mb-1">• {ex.label === "CĐ" ? "Cực đại" : ex.label === "CT" ? "Cực tiểu" : "Cực trị"} tại <i>x</i> = {formatNum(ex.x)}, <i>y</i> = {formatNum(ex.y)}</div>); }); }
            if (analysis.asymptotes.length === 0) asymStr.push("Không có tiệm cận"); else { analysis.asymptotes.forEach((asym, idx) => { if (asym.type === 'vertical') asymStr.push(<div key={`v-${idx}`}>• TC đứng: <i>x</i> = {formatNum(asym.val)}</div>); if (asym.type === 'horizontal') asymStr.push(<div key={`h-${idx}`}>• TC ngang: <i>y</i> = {formatNum(asym.val)}</div>); if (asym.type === 'slant') asymStr.push(<div key={`s-${idx}`}>• TC xiên: <i>y</i> = {formatNum(asym.m)}<i>x</i> {asym.k>=0?'+':'−'} {formatNum(Math.abs(asym.k))}</div>); }); }
            return (
                <div className="text-base text-blue-900 leading-relaxed" style={{fontFamily: MATH_FONT_FAMILY}}>
                    <div className="mb-2 font-bold underline">a) Tập xác định:</div><div className="mb-3 pl-3 font-bold">{domainStr || "D = ℝ"}</div>
                    <div className="mb-2 font-bold underline">b) Đạo hàm:</div><div className="mb-3 pl-3 font-bold">{derivDisplay || "Đang cập nhật..."}</div>
                    <div className="mb-2 font-bold underline">c) Cực trị:</div><div className="mb-3 pl-3">{extremaStr}</div>
                    <div className="mb-2 font-bold underline">d) Tiệm cận:</div><div className="pl-3">{asymStr}</div>
                </div>
            );
        };

        const BBT = ({ analysis, funcType, coeffs, config }) => {
            if (!analysis || !analysis.valid) return <div className="p-5 text-blue-900 font-bold text-lg">Đang tính toán...</div>;
            if (['trig', 'trig_cos', 'trig_tan', 'trig_cot'].includes(funcType)) return <div className="p-5 text-center">Hàm tuần hoàn - Xem đồ thị</div>;

            const bbtStyle = { fontFamily: MATH_FONT_FAMILY, fontSize: `${config.fontSize}pt`, color: DEFAULT_BLUE };
            const borderStyle = { borderColor: DEFAULT_BLUE, borderWidth: `${config.bbtLineWidth}px`, borderStyle: 'solid' };
            const borderR = { borderRightColor: DEFAULT_BLUE, borderRightWidth: `${config.bbtLineWidth}px`, borderRightStyle: 'solid' };
            const borderB = { borderBottomColor: DEFAULT_BLUE, borderBottomWidth: `${config.bbtLineWidth}px`, borderBottomStyle: 'solid' };
            const hugeTextStyle = { fontSize: '1.2em', lineHeight: '1' };
            const DoubleBar = () => (<div className="h-full w-full flex justify-center items-center"><div className="h-full w-[2px]" style={{ backgroundColor: DEFAULT_BLUE }}></div><div className="h-full w-[2px] ml-[3px]" style={{ backgroundColor: DEFAULT_BLUE }}></div></div>);
            const ColPoint = ({ children }) => <div className="w-16 flex items-center justify-center font-bold relative h-full">{children}</div>;
            const ColInterval = ({ children }) => <div className="flex-1 flex justify-between items-center relative h-full px-2">{children}</div>;
            const cellHeader = `w-16 flex items-center justify-center font-bold bg-white`;
            const latexHeaderStyle = { fontFamily: MATH_FONT_FAMILY, fontStyle: 'italic', fontWeight: 'bold' };

            if (funcType === 'logarithmic') {
                const { domainMin, mainSign } = analysis;
                const sign = mainSign > 0 ? '+' : '−';
                return (
                    <div className="w-full bg-white" style={{ ...bbtStyle, ...borderStyle }}>
                        <div className="flex h-12" style={borderB}><div className={cellHeader} style={{...borderR, ...latexHeaderStyle}}>x</div><div className="flex-1 flex items-center justify-between px-2"><ColPoint>{formatNum(domainMin)}</ColPoint><ColInterval><span className="ml-auto" style={hugeTextStyle}>+∞</span></ColInterval></div></div>
                        <div className="flex h-12"><div className={cellHeader} style={{...borderR, ...latexHeaderStyle}}>y'</div><div className="flex-1 flex items-center"><ColPoint><DoubleBar/></ColPoint><ColInterval><div className="w-full text-center font-bold text-xl">{sign}</div></ColInterval></div></div>
                    </div>
                );
            }
            if (funcType === 'exponential') {
                const { mainSign } = analysis;
                const sign = mainSign > 0 ? '+' : '−';
                return (
                    <div className="w-full bg-white" style={{ ...bbtStyle, ...borderStyle }}>
                        <div className="flex h-12" style={borderB}><div className={cellHeader} style={{...borderR, ...latexHeaderStyle}}>x</div><div className="flex-1 flex items-center justify-between px-2"><ColInterval><span style={hugeTextStyle}>−∞</span></ColInterval><ColInterval><span className="ml-auto" style={hugeTextStyle}>+∞</span></ColInterval></div></div>
                        <div className="flex h-12"><div className={cellHeader} style={{...borderR, ...latexHeaderStyle}}>y'</div><div className="flex-1 flex items-center"><ColInterval><div className="w-full text-center font-bold text-xl">{sign}</div></ColInterval></div></div>
                    </div>
                );
            }
            const { roots, extrema, poles, mainSign } = analysis;
            const allPoles = poles || [];
            let keyPoints = [...roots, ...allPoles].sort((a, b) => a - b);
            let signs = []; let currentSign = mainSign; signs[keyPoints.length] = currentSign;
            for (let i = keyPoints.length - 1; i >= 0; i--) { const p = keyPoints[i]; if (roots.some(r => Math.abs(r-p) < 1e-5)) currentSign = -currentSign; signs[i] = currentSign; }
            return (
                <div className="w-full bg-white" style={{ ...bbtStyle, ...borderStyle }}>
                    <div className="flex h-12" style={borderB}>
                        <div className={cellHeader} style={{...borderR, ...latexHeaderStyle}}>x</div>
                        <div className="flex-1 flex items-center justify-between px-2">
                             <ColInterval><span style={hugeTextStyle}>−∞</span></ColInterval>
                             {keyPoints.map((p,i) => <React.Fragment key={i}><ColPoint>{formatNum(p)}</ColPoint><ColInterval><span className={i===keyPoints.length-1?"ml-auto":""} style={hugeTextStyle}>{i===keyPoints.length-1?"+∞":""}</span></ColInterval></React.Fragment>)}
                        </div>
                    </div>
                    <div className="flex h-12">
                        <div className={cellHeader} style={{...borderR, ...latexHeaderStyle}}>y'</div>
                        <div className="flex-1 flex items-center">
                            {signs.map((s, i) => <React.Fragment key={i}><ColInterval><div className="w-full text-center font-bold text-xl">{s>0?'+':'−'}</div></ColInterval>{i < keyPoints.length && <ColPoint>{roots.some(r => Math.abs(r-keyPoints[i]) < 1e-5) ? "0" : <DoubleBar/>}</ColPoint>}</React.Fragment>)}
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENT CHÍNH ---
        function App() {
          const [funcType, setFuncType] = useState('rational21');
          const [coeffs, setCoeffs] = useState({ a: 1, b: 1, c: 4, d: 1, e: 1 });
          const [analysis, setAnalysis] = useState(null);
          const [errorMsg, setErrorMsg] = useState('');
          const [jsonCode, setJsonCode] = useState('');
          const [showAnalysis, setShowAnalysis] = useState(false);
          const [viewConfig, setViewConfig] = useState({ grid: true, asymptotes: true, extrema: true, intersections: true, projections: true });
          const [config, setConfig] = useState({ fontSize: 16, strokeWidth: 2, graphColor: DEFAULT_BLUE, zoom: 1.0, bbtLineWidth: 2 });
          
          // --- NEW STATES: FULLSCREEN & INTERSECTION & HELP ---
          const [isGraphFullscreen, setIsGraphFullscreen] = useState(false);
          const [intersection, setIntersection] = useState({ active: false, m: 0 });
          const [showHelp, setShowHelp] = useState(false);

          const canvasRef = useRef(null);
          const printRef = useRef(null);

          const functionOptions = [
            { id: 'cubic', label: '1. Hàm bậc ba (Cubic)' }, { id: 'quartic', label: '2. Hàm trùng phương (Quartic)' },
            { id: 'quadratic', label: '3. Hàm bậc hai (Quadratic)' }, { id: 'rational11', label: '4. Hàm phân thức 1/1' },
            { id: 'rational21', label: '5. Hàm phân thức 2/1' }, { id: 'trig', label: '6. Hàm lượng giác (Sin)' },
            { id: 'trig_cos', label: '7. Hàm lượng giác (Cos)' }, { id: 'trig_tan', label: '8. Hàm lượng giác (Tan)' },
            { id: 'trig_cot', label: '9. Hàm lượng giác (Cot)' }, { id: 'exponential', label: '10. Hàm số mũ' },
            { id: 'logarithmic', label: '11. Hàm số logarit' },
          ];

          useEffect(() => { try { analyzeFunction(); setErrorMsg(''); setShowAnalysis(false); } catch (err) { console.error(err); setErrorMsg("Có lỗi khi tính toán."); } }, [coeffs, funcType]);
          const handleInputChange = (e) => { setCoeffs({ ...coeffs, [e.target.name]: parseFloat(e.target.value) || 0 }); };
          const selectFunctionType = (type) => { setFuncType(type); if (type==='cubic') setCoeffs({a:1,b:-3,c:0,d:2,e:0}); else if (type==='rational11') setCoeffs({a:2,b:-3,c:1,d:-1,e:0}); else if (type==='rational21') setCoeffs({a:1,b:-3,c:3,d:1,e:-1}); }
          const toggleLayer = (layer) => { setViewConfig(prev => ({ ...prev, [layer]: !prev[layer] })); };
          
          const analyzeFunction = () => {
            const { a, b, c, d, e } = coeffs;
            let result = { type: funcType, coeffs: coeffs, roots: [], extrema: [], asymptotes: [], valid: true, domain: [-Infinity, Infinity], specialPoints: [], intersections: [], poles: [] };
            const addIntersection = (val, axis) => { if (!isFinite(val)) return; if (Math.abs(val) < 1e-9 && axis === 'x') return; result.intersections.push({ val, axis }); };
            const addPoint = (x, y, label, type) => { if (!isFinite(x) || !isFinite(y)) return; result.specialPoints.push({ x, y, label, type }); };
            
            if (funcType === 'cubic') { if (Math.abs(a) < 1e-9) { result.valid = false; result.msg = "Hệ số a phải khác 0"; } else { const derivRoots = solveQuadratic(3 * a, 2 * b, c); result.roots = derivRoots; result.extrema = derivRoots.map((x, idx) => { const y = a * x * x * x + b * x * x + c * x + d; let label = ""; if (derivRoots.length === 2) { if (a > 0) label = idx === 0 ? "CĐ" : "CT"; else label = idx === 0 ? "CT" : "CĐ"; } addPoint(x, y, label, "extrema"); return { x, y, label }; }); result.mainSign = a > 0 ? 1 : -1; addIntersection(d, 'y'); } }
            else if (funcType === 'quadratic') { if (Math.abs(a) < 1e-9) { result.valid = false; result.msg = "Hệ số a phải khác 0"; } else { const vertexX = -b / (2 * a); const vertexY = a * vertexX * vertexX + b * vertexX + c; const label = a > 0 ? "CT" : "CĐ"; result.roots = [vertexX]; result.extrema = [{ x: vertexX, y: vertexY, label }]; result.mainSign = a > 0 ? 1 : -1; addPoint(vertexX, vertexY, "I", "vertex"); addIntersection(c, 'y'); solveQuadratic(a, b, c).forEach(x => addIntersection(x, 'x')); } }
            else if (funcType === 'quartic') { if (Math.abs(a) < 1e-9) { result.valid = false; result.msg = "Hệ số a phải khác 0"; } else { let derivRoots = [0]; const valSquared = -b / (2 * a); if (valSquared > 0) { const val = Math.sqrt(valSquared); derivRoots.push(-val); derivRoots.push(val); } derivRoots.sort((u, v) => u - v); result.roots = derivRoots; result.extrema = derivRoots.map(x => { const x2 = x * x; const y = a * x2 * x2 + b * x2 + c; let label = ""; if (derivRoots.length === 3) { if (a > 0) label = (Math.abs(x) < 1e-9) ? "CĐ" : "CT"; else label = (Math.abs(x) < 1e-9) ? "CT" : "CĐ"; } else { if (a > 0) label = "CT"; else label = "CĐ"; } addPoint(x, y, label, "extrema"); return { x, y, label }; }); result.mainSign = a > 0 ? 1 : -1; addIntersection(c, 'y'); solveQuadratic(a, b, c).forEach(t => { if (t > 0) { const sqrtT = Math.sqrt(t); addIntersection(-sqrtT, 'x'); addIntersection(sqrtT, 'x'); } else if (Math.abs(t) < 1e-9) { addIntersection(0, 'x'); } }); } }
            else if (funcType === 'rational11') { if (Math.abs(c) < 1e-9 || Math.abs(a * d - b * c) < 1e-9) { result.valid = false; result.msg = "Hệ số không hợp lệ"; } else { const p = -d / c; result.poles = [p]; result.asymptotes.push({ type: 'vertical', val: p }); result.asymptotes.push({ type: 'horizontal', val: a / c }); result.yPrimeNum = a * d - b * c; result.tcn = a / c; addPoint(-d / c, a / c, "I", "center"); if (p !== 0) addIntersection(b / d, 'y'); if (Math.abs(a) > 1e-9) addIntersection(-b / a, 'x'); } }
            else if (funcType === 'rational21') { if (Math.abs(d) < 1e-9 || Math.abs(a) < 1e-9) { result.valid = false; result.msg = "Hệ số không hợp lệ"; } else { const p = -e / d; result.poles = [p]; result.asymptotes.push({ type: 'vertical', val: p }); const slope = a / d; const intercept = b / d - (a * e) / (d * d); result.asymptotes.push({ type: 'slant', m: slope, k: intercept }); const numA = a * d; const numB = 2 * a * e; const numC = b * e - c * d; const derivRoots = solveQuadratic(numA, numB, numC).filter(x => Math.abs(x - p) > 1e-5); result.roots = derivRoots; result.extrema = derivRoots.map(x => { const y = (a * x * x + b * x + c) / (d * x + e); addPoint(x, y, "", "extrema"); return { x, y, label: "" }; }); if (result.extrema.length === 2) { const numA = a * d; const numB = 2 * a * e; result.extrema.forEach(ex => { const N_prime = 2*numA*ex.x + numB; if (N_prime > 0) ex.label = "CT"; else ex.label = "CĐ"; }); } result.mainSign = (a / d) > 0 ? 1 : -1; addPoint(p, slope * p + intercept, "I", "center"); if (Math.abs(p) > 1e-9 && Math.abs(e) > 1e-9) addIntersection(c / e, 'y'); solveQuadratic(a, b, c).forEach(r => { if (Math.abs(r - p) > 1e-5) addIntersection(r, 'x'); }); } }
            else if (funcType === 'trig') { if (Math.abs(a) < 1e-9 || Math.abs(b) < 1e-9) { result.valid = false; result.msg = "Hệ số a, b phải khác 0"; } else { result.periodic = true; result.period = (2 * Math.PI) / Math.abs(b); for (let k = -5; k <= 5; k++) { const val1 = (Math.PI/2 - c + k*2*Math.PI)/b; const val2 = (-Math.PI/2 - c + k*2*Math.PI)/b; if (Math.abs(val1) < 12) addPoint(val1, a * Math.sin(b*val1+c) + d, "", "extrema"); if (Math.abs(val2) < 12) addPoint(val2, a * Math.sin(b*val2+c) + d, "", "extrema"); } addIntersection(a*Math.sin(c)+d, 'y'); } }
            else if (funcType === 'trig_cos') { if (Math.abs(a) < 1e-9 || Math.abs(b) < 1e-9) { result.valid = false; result.msg = "Hệ số a, b phải khác 0"; } else { result.periodic = true; result.period = (2 * Math.PI) / Math.abs(b); for (let k = -5; k <= 5; k++) { const val1 = (0 - c + k*2*Math.PI)/b; const val2 = (Math.PI - c + k*2*Math.PI)/b; if (Math.abs(val1) < 12) addPoint(val1, a * Math.cos(b*val1+c) + d, "", "extrema"); if (Math.abs(val2) < 12) addPoint(val2, a * Math.cos(b*val2+c) + d, "", "extrema"); } addIntersection(a*Math.cos(c)+d, 'y'); } }
            else if (funcType === 'trig_tan') { if (Math.abs(a) < 1e-9 || Math.abs(b) < 1e-9) { result.valid = false; result.msg = "Hệ số a, b phải khác 0"; } else { result.periodic = true; result.period = Math.PI / Math.abs(b); if (Math.abs(Math.cos(c)) > 1e-9) addIntersection(a*Math.tan(c)+d, 'y'); } }
            else if (funcType === 'trig_cot') { if (Math.abs(a) < 1e-9 || Math.abs(b) < 1e-9) { result.valid = false; result.msg = "Hệ số a, b phải khác 0"; } else { result.periodic = true; result.period = Math.PI / Math.abs(b); if (Math.abs(Math.sin(c)) > 1e-9) addIntersection(a*(1/Math.tan(c))+d, 'y'); } }
            else if (funcType === 'logarithmic') { if (b <= 0 || b === 1) { result.valid = false; result.msg = "Cơ số b phải > 0 và khác 1"; } else if (Math.abs(a) < 1e-9) { result.valid = false; result.msg = "Hệ số a phải khác 0"; } else { result.domainMin = -c; result.asymptotes.push({ type: 'vertical', val: -c }); const lnB = Math.log(b); result.mainSign = (a / lnB) > 0 ? 1 : -1; const rootX = Math.pow(b, -d/a) - c; addIntersection(rootX, 'x'); if (c > 0) { const yAt0 = a * (Math.log(c) / Math.log(b)) + d; addIntersection(yAt0, 'y'); } } }
            else if (funcType === 'exponential') { if (b <= 0 || b === 1) { result.valid = false; result.msg = "Cơ số b phải > 0 và khác 1"; } else if (Math.abs(a) < 1e-9) { result.valid = false; result.msg = "Hệ số a phải khác 0"; } else { result.asymptotes.push({ type: 'horizontal', val: d }); const lnB = Math.log(b); result.mainSign = (a * lnB) > 0 ? 1 : -1; if (-d/a > 0) { const val = Math.log(-d/a) / Math.log(b) - c; addIntersection(val, 'x'); } const yAt0 = a * Math.pow(b, c) + d; addIntersection(yAt0, 'y'); } }
            setAnalysis(result);
          };

          useEffect(() => { if (analysis && analysis.valid) draw(); }, [analysis, config, viewConfig, intersection, isGraphFullscreen]); // Redraw on fullscreen toggle

          const draw = () => {
            const canvas = canvasRef.current; if (!canvas) return; const ctx = canvas.getContext('2d'); 
            
            // --- FULLSCREEN LOGIC ---
            // Nếu đang fullscreen, lấy kích thước cửa sổ. Nếu không, lấy kích thước mặc định 650x500
            const w = isGraphFullscreen ? window.innerWidth : 650;
            const h = isGraphFullscreen ? window.innerHeight : 500;
            
            // Cập nhật thuộc tính width/height cho canvas để tránh bị vỡ hình
            canvas.width = w;
            canvas.height = h;

            ctx.fillStyle = "white"; ctx.fillRect(0, 0, w, h);

            let xMin = -6, xMax = 6, yMin = -6, yMax = 6;
            if (analysis && analysis.valid) {
              const importantX = [0]; const importantY = [0];
              if (analysis.roots) analysis.roots.forEach(r => importantX.push(r));
              if (analysis.extrema) analysis.extrema.forEach(p => { importantX.push(p.x); importantY.push(p.y); });
              if (analysis.intersections) analysis.intersections.forEach(p => { if (p.axis==='x') importantX.push(p.val); else importantY.push(p.val); });
              if (funcType === 'logarithmic') { importantX.push(analysis.domainMin); importantX.push(analysis.domainMin + 5); }
              if (funcType === 'exponential') { importantY.push(coeffs.d); importantY.push(coeffs.d + (coeffs.a > 0 ? 2 : -2)); }
              
              if (intersection.active) importantY.push(parseFloat(intersection.m));

              let minX = Math.min(...importantX), maxX = Math.max(...importantX); let minY = Math.min(...importantY), maxY = Math.max(...importantY);
              let rX = maxX - minX, rY = maxY - minY; xMin = minX - Math.max(2, rX*0.2); xMax = maxX + Math.max(2, rX*0.2); yMin = minY - Math.max(2, rY*0.2); yMax = maxY + Math.max(2, rY*0.2);
            }
            
            // Nếu fullscreen, tăng vùng nhìn thấy lên một chút cho thoáng
            if (isGraphFullscreen) {
                const aspect = w / h;
                const currentW = xMax - xMin;
                const currentH = yMax - yMin;
                if (aspect > currentW/currentH) {
                    const newW = currentH * aspect;
                    const delta = (newW - currentW) / 2;
                    xMin -= delta; xMax += delta;
                } else {
                    const newH = currentW / aspect;
                    const delta = (newH - currentH) / 2;
                    yMin -= delta; yMax += delta;
                }
            }

            const scaleX = w / (xMax - xMin); const scaleY = h / (yMax - yMin);
            const toSX = (x) => (x - xMin) * scaleX; const toSY = (y) => h - (y - yMin) * scaleY; const yOrigin = toSY(0); const xOrigin = toSX(0);

            const drawGridAndAxes = () => {
               if (!viewConfig.grid) return; 
               let gridStep = 1; if ((xMax - xMin) > 20) gridStep = 2; if ((xMax - xMin) > 50) gridStep = 5;
               ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1; ctx.beginPath(); for (let x = Math.ceil(xMin/gridStep)*gridStep; x <= xMax; x += gridStep) { ctx.moveTo(toSX(x), 0); ctx.lineTo(toSX(x), h); } for (let y = Math.ceil(yMin/gridStep)*gridStep; y <= yMax; y += gridStep) { ctx.moveTo(0, toSY(y)); ctx.lineTo(w, toSY(y)); } ctx.stroke();
               ctx.strokeStyle = DEFAULT_BLUE; ctx.fillStyle = DEFAULT_BLUE; ctx.lineWidth = config.strokeWidth; const arrowSize = 6;
               if (yOrigin >= -20 && yOrigin <= h + 20) { ctx.beginPath(); ctx.moveTo(0, yOrigin); ctx.lineTo(w - arrowSize, yOrigin); ctx.stroke(); ctx.beginPath(); ctx.moveTo(w, yOrigin); ctx.lineTo(w - 12, yOrigin - 4); ctx.lineTo(w - 12, yOrigin + 4); ctx.closePath(); ctx.fill(); }
               if (xOrigin >= -20 && xOrigin <= w + 20) { ctx.beginPath(); ctx.moveTo(xOrigin, h); ctx.lineTo(xOrigin, arrowSize); ctx.stroke(); ctx.beginPath(); ctx.moveTo(xOrigin, 0); ctx.lineTo(xOrigin - 4, 12); ctx.lineTo(xOrigin + 4, 12); ctx.closePath(); ctx.fill(); }
               ctx.font = `italic bold ${config.fontSize + 4}pt ${MATH_FONT_FAMILY}`; if (yOrigin >= -20 && yOrigin <= h + 20) ctx.fillText("x", w - 20, yOrigin - 12); if (xOrigin >= -20 && xOrigin <= w + 20) ctx.fillText("y", xOrigin + 12, 25); if (xOrigin >= 0 && xOrigin <= w && yOrigin >= 0 && yOrigin <= h) ctx.fillText("O", xOrigin - 25, yOrigin + 25);
            };
            drawGridAndAxes();

            ctx.strokeStyle = config.graphColor; ctx.lineWidth = config.strokeWidth; ctx.beginPath(); const step = (xMax - xMin) / (isGraphFullscreen ? 3000 : 1500); let prevX = xMin; let isDiscontinuous = false;
            for (let x = xMin; x <= xMax; x += step) { const y = getFunctionValue(x, funcType, coeffs); if (analysis.poles && analysis.poles.length > 0) { if (analysis.poles.some(p => prevX < p && x >= p)) isDiscontinuous = true; } const sy = toSY(y); if (!isFinite(y) || sy < -h * 2 || sy > h * 3) isDiscontinuous = true; else { const sx = toSX(x); if (isDiscontinuous) { ctx.stroke(); ctx.beginPath(); ctx.moveTo(sx, sy); isDiscontinuous = false; } else ctx.lineTo(sx, sy); } prevX = x; } ctx.stroke();

             if (intersection.active) {
                const m = parseFloat(intersection.m);
                ctx.beginPath(); ctx.moveTo(0, toSY(m)); ctx.lineTo(w, toSY(m));
                ctx.strokeStyle = '#d97706'; ctx.lineWidth = 2; ctx.stroke(); 
                ctx.fillStyle = '#d97706'; ctx.font = `bold ${config.fontSize}pt ${MATH_FONT_FAMILY}`;
                ctx.fillText(`y = ${m}`, 10, toSY(m) - 5);
                let points = []; let prevVal = getFunctionValue(xMin, funcType, coeffs); const searchStep = (xMax - xMin) / 2000;
                for (let x = xMin; x <= xMax; x += searchStep) { const val = getFunctionValue(x, funcType, coeffs); if (Math.abs(val - prevVal) > 5) { prevVal = val; continue; } if ((val - m) * (prevVal - m) <= 0) { const xRoot = x - searchStep/2; points.push({x: xRoot, y: m}); } prevVal = val; }
                ctx.fillStyle = '#dc2626'; points.forEach(p => { const sx = toSX(p.x); const sy = toSY(p.y); ctx.beginPath(); ctx.arc(sx, sy, 5, 0, 2*Math.PI); ctx.fill(); ctx.fillStyle = '#000'; ctx.font = `italic ${config.fontSize-2}pt ${MATH_FONT_FAMILY}`; ctx.fillText(`(${formatNum(p.x)}; ${m})`, sx + 8, sy - 8); });
                ctx.fillStyle = '#dc2626'; ctx.font = `bold ${config.fontSize+2}pt ${MATH_FONT_FAMILY}`; ctx.fillText(`Số giao điểm: ${points.length}`, 20, 30);
            }

            if (analysis && analysis.valid) {
               if (viewConfig.asymptotes) { ctx.setLineDash([8, 8]); ctx.strokeStyle = DEFAULT_BLUE; ctx.lineWidth = 3; if (analysis.asymptotes) analysis.asymptotes.forEach(asym => { ctx.beginPath(); if (asym.type === 'vertical') { ctx.moveTo(toSX(asym.val), 0); ctx.lineTo(toSX(asym.val), h); } else if (asym.type === 'horizontal') { ctx.moveTo(0, toSY(asym.val)); ctx.lineTo(w, toSY(asym.val)); } else if (asym.type === 'slant') { const y1 = asym.m * xMin + asym.k; const y2 = asym.m * xMax + asym.k; ctx.moveTo(toSX(xMin), toSY(y1)); ctx.lineTo(toSX(xMax), toSY(y2)); } ctx.stroke(); }); ctx.setLineDash([]); }
               const drawTickX = (val, text, dx = 0, dy = 0) => { const sx = toSX(val); if (sx < 0 || sx > w) return; ctx.beginPath(); ctx.moveTo(sx, yOrigin - 4); ctx.lineTo(sx, yOrigin + 4); ctx.stroke(); ctx.save(); ctx.font = `${config.fontSize}pt ${MATH_FONT_FAMILY}`; ctx.fillStyle = DEFAULT_BLUE; ctx.fillText(text, sx - 5 + dx, yOrigin + 20 + dy); ctx.restore(); };
               const drawTickY = (val, text, dx = 0, dy = 0) => { const sy = toSY(val); if (sy < 0 || sy > h) return; ctx.beginPath(); ctx.moveTo(xOrigin - 4, sy); ctx.lineTo(xOrigin + 4, sy); ctx.stroke(); ctx.save(); ctx.font = `${config.fontSize}pt ${MATH_FONT_FAMILY}`; ctx.fillStyle = DEFAULT_BLUE; ctx.fillText(text, xOrigin + 8 + dx, sy + 5 + dy); ctx.restore(); };
               ctx.strokeStyle = DEFAULT_BLUE; ctx.fillStyle = DEFAULT_BLUE; ctx.lineWidth = 1.5;
               if (viewConfig.intersections && analysis.intersections) { analysis.intersections.forEach(p => { if (p.axis === 'x') drawTickX(p.val, formatNum(p.val)); if (p.axis === 'y') drawTickY(p.val, formatNum(p.val)); }); }
               if (analysis.specialPoints) analysis.specialPoints.forEach(p => { const sx = toSX(p.x); const sy = toSY(p.y); if (sx >= -50 && sx <= w + 50 && sy >= -50 && sy <= h + 50) { let shouldDraw = false; if (p.type === 'extrema' || p.type === 'center' || p.type === 'vertex' || p.type === 'inflection') { if (viewConfig.extrema) shouldDraw = true; } if (shouldDraw) { if (viewConfig.projections) { if (!['trig', 'trig_cos', 'trig_tan', 'trig_cot'].includes(funcType)) { ctx.save(); ctx.setLineDash([4, 4]); ctx.lineWidth = 1.5; ctx.strokeStyle = DEFAULT_BLUE; ctx.beginPath(); if (Math.abs(p.y) > 0.1) { ctx.moveTo(sx, sy); ctx.lineTo(sx, yOrigin); } if (Math.abs(p.x) > 0.1) { ctx.moveTo(sx, sy); ctx.lineTo(xOrigin, sy); } ctx.stroke(); ctx.restore(); } } ctx.beginPath(); ctx.arc(sx, sy, 4, 0, 2 * Math.PI); ctx.fill(); ctx.save(); ctx.font = `bold ${config.fontSize}pt ${MATH_FONT_FAMILY}`; ctx.fillStyle = DEFAULT_BLUE; if (p.label) ctx.fillText(p.label, sx + 5, sy + (p.y >= 0 ? -10 : 20)); ctx.restore(); } } });
            }
          };

          const handleExportReport = () => {
              const reportArea = document.getElementById('print-area');
              const canvasImg = canvasRef.current.toDataURL("image/png");
              document.getElementById('report-graph-img').src = canvasImg;
              html2canvas(reportArea, { scale: 2 }).then(canvas => {
                  const link = document.createElement('a');
                  link.download = `NTMA_PhieuBaiTap_${funcType}.png`;
                  link.href = canvas.toDataURL();
                  link.click();
              });
          };

          return (
            <div className="flex h-screen overflow-hidden font-serif" style={{ fontFamily: FONT_FAMILY }}>
              {showHelp && (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 animate-in fade-in backdrop-blur-sm">
                    <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full overflow-hidden modal-animate transform transition-all">
                    <div className="bg-blue-900 p-4 flex justify-between items-center text-white">
                        <div className="flex items-center"><HelpCircle className="w-6 h-6 mr-2"/><h3 className="font-bold text-xl">Hướng dẫn sử dụng</h3></div>
                        <button onClick={() => setShowHelp(false)} className="hover:bg-blue-800 rounded-full p-1"><XCircle className="w-6 h-6"/></button>
                    </div>
                    <div className="p-6 space-y-6">
                        <div className="flex items-start"><div className="bg-blue-100 text-blue-800 font-bold rounded-full w-10 h-10 flex items-center justify-center mr-4 flex-shrink-0 text-lg shadow-sm">1</div><div><h4 className="font-bold text-blue-900 text-lg mb-1">Chọn Hàm & Nhập Số</h4><p className="text-gray-600 leading-relaxed">Chọn loại hàm số ở cột trái và nhập hệ số a, b, c... Đồ thị sẽ tự động vẽ.</p></div></div>
                        <div className="flex items-start"><div className="bg-blue-100 text-blue-800 font-bold rounded-full w-10 h-10 flex items-center justify-center mr-4 flex-shrink-0 text-lg shadow-sm">2</div><div><h4 className="font-bold text-blue-900 text-lg mb-1">Tương Giao Đồ Thị (Mới)</h4><p className="text-gray-600 leading-relaxed">Bật công tắc <span className="font-bold">"Bài toán Tương giao"</span> bên trái. Kéo thanh trượt m để biện luận số nghiệm.</p></div></div>
                        <div className="flex items-start"><div className="bg-blue-100 text-blue-800 font-bold rounded-full w-10 h-10 flex items-center justify-center mr-4 flex-shrink-0 text-lg shadow-sm">3</div><div><h4 className="font-bold text-blue-900 text-lg mb-1">Xuất Báo Cáo</h4><p className="text-gray-600 leading-relaxed">Bấm nút <span className="font-bold text-amber-600">Tải Phiếu</span> ở góc trên để lưu bài làm dạng ảnh đẹp mắt.</p></div></div>
                        <div className="mt-6 pt-6 border-t border-gray-100 text-center"><button onClick={() => setShowHelp(false)} className="px-8 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-lg hover:shadow-xl transition-all">Đã hiểu, bắt đầu ngay!</button></div>
                    </div>
                    </div>
                </div>
              )}
              <div id="print-area" className="bg-white p-10 w-[800px] text-blue-900 border border-gray-300">
                  <div className="text-center border-b-2 border-blue-900 pb-4 mb-6"><h1 className="text-3xl font-bold uppercase">PHIẾU BÀI TẬP KHẢO SÁT HÀM SỐ</h1><p className="text-gray-600 italic mt-1">Hệ thống hỗ trợ dạy và học toán THPT - NTMA</p></div>
                  <div className="mb-6"><h2 className="text-xl font-bold mb-2 uppercase border-l-4 border-blue-600 pl-2">I. Đề bài</h2><div className="bg-gray-50 p-4 rounded text-xl text-center border border-gray-200"><MathFormula type={funcType} {...coeffs} fontSize={24} /></div></div>
                  <div className="mb-6"><h2 className="text-xl font-bold mb-2 uppercase border-l-4 border-blue-600 pl-2">II. Lời giải chi tiết</h2><div className="bg-white p-2 border border-gray-200 rounded"><AnalysisResults analysis={analysis} funcType={funcType} coeffs={coeffs} /></div></div>
                  <div className="mb-6"><h2 className="text-xl font-bold mb-2 uppercase border-l-4 border-blue-600 pl-2">III. Bảng xét dấu</h2><div className="border border-gray-300 p-2"><BBT analysis={analysis} funcType={funcType} coeffs={coeffs} config={{...config, fontSize: 14}} /></div></div>
                  <div className="mb-4"><h2 className="text-xl font-bold mb-2 uppercase border-l-4 border-blue-600 pl-2">IV. Đồ thị hàm số</h2><div className="flex justify-center border border-gray-200 p-2 rounded"><img id="report-graph-img" alt="Graph" className="max-w-full h-auto" /></div></div>
                  <div className="text-center text-sm text-gray-400 mt-8 pt-4 border-t">Được tạo tự động bởi phần mềm NTMA</div>
              </div>
              
              <div className="w-[60%] flex-shrink-0 border-r border-gray-300 bg-white flex flex-col z-10 shadow-lg overflow-hidden">
                <div className="bg-blue-900 p-5 relative flex items-center shadow-md h-20">
                   <div className="absolute left-5 font-bold text-2xl text-white tracking-wide z-10" style={{ fontFamily: FONT_FAMILY }}>NTMA</div>
                   <div className="w-full text-center"><h1 className="text-3xl font-bold uppercase text-amber-400 tracking-wider" style={{ fontFamily: FONT_FAMILY }}>CÁC HÀM SỐ HAY GẶP THPT</h1></div>
                   <div className="absolute right-5 z-10 flex gap-2">
                       <button onClick={() => setShowHelp(true)} className="bg-white/20 hover:bg-white/30 text-white p-1.5 rounded-full transition-colors flex-shrink-0" title="Hướng dẫn sử dụng"><QuestionIcon className="w-6 h-6"/></button>
                       <button onClick={handleExportReport} className="bg-amber-500 hover:bg-amber-600 text-white px-3 py-1 rounded shadow flex items-center text-sm font-bold" title="Tải phiếu bài tập"><Download className="w-4 h-4 mr-1"/> Tải Phiếu</button>
                       <Settings className="w-7 h-7 text-white opacity-80 cursor-pointer hover:opacity-100 flex-shrink-0" />
                   </div>
                </div>
                <div className="flex-1 overflow-y-auto p-5 bg-[#F5F5F5]">
                  <div className="grid grid-cols-2 gap-5">
                    <div className="bg-white p-4 rounded-xl shadow border border-gray-300 col-span-1">
                     <label className="block text-lg font-bold mb-3 text-blue-900 flex items-center" style={{ fontFamily: FONT_FAMILY }}><List className="w-5 h-5 mr-2" /> 1. Chọn Hàm Số</label>
                      <div className="space-y-2 h-48 overflow-y-auto pr-1">
                      {functionOptions.map(opt => ( <button key={opt.id} onClick={() => selectFunctionType(opt.id)} className={`w-full text-left px-4 py-3 rounded border font-bold text-base flex items-center ${funcType === opt.id ? 'bg-blue-50 border-blue-900 text-blue-900' : 'bg-white border-gray-300 text-gray-600 hover:bg-gray-50'}`} style={{ fontFamily: FONT_FAMILY }}>{funcType === opt.id ? <CheckCircle2 className="w-5 h-5 mr-2 text-blue-900" /> : <div className="w-5 h-5 mr-2" />}{opt.label}</button>))}
                    </div>
                   </div>
                    <div className="bg-white p-4 rounded-xl shadow border border-gray-300 col-span-1">
                     <label className="block text-lg font-bold mb-3 text-blue-900 flex items-center" style={{ fontFamily: FONT_FAMILY }}><Calculator className="w-5 h-5 mr-2" /> 2. Nhập hệ số vào đây</label>
                      <div className="mb-3 text-center bg-gray-50 py-3 rounded border border-gray-200"><MathFormula type={funcType} {...coeffs} fontSize={16} /></div>
                      <div className="grid grid-cols-2 gap-3 text-base">
                        <div className="flex items-center"><span className="w-8 font-bold text-blue-900 text-lg">a:</span><input type="number" name="a" value={coeffs.a} onChange={handleInputChange} className="w-16 border border-gray-300 rounded p-1 text-center font-bold text-blue-900 ml-1 text-lg"/></div>
                        <div className="flex items-center"><span className="w-8 font-bold text-blue-900 text-lg">b:</span><input type="number" name="b" value={coeffs.b} onChange={handleInputChange} className="w-16 border border-gray-300 rounded p-1 text-center font-bold text-blue-900 ml-1 text-lg"/></div>
                         <div className="flex items-center"><span className="w-8 font-bold text-blue-900 text-lg">c:</span><input type="number" name="c" value={coeffs.c} onChange={handleInputChange} className="w-16 border border-gray-300 rounded p-1 text-center font-bold text-blue-900 ml-1 text-lg"/></div>
                        {(['cubic', 'rational11', 'rational21', 'trig', 'trig_cos', 'trig_tan', 'trig_cot', 'logarithmic', 'exponential'].includes(funcType)) && <div className="flex items-center"><span className="w-8 font-bold text-blue-900 text-lg">d:</span><input type="number" name="d" value={coeffs.d} onChange={handleInputChange} className="w-16 border border-gray-300 rounded p-1 text-center font-bold text-blue-900 ml-1 text-lg"/></div>}
                        {(['rational21'].includes(funcType)) && <div className="flex items-center"><span className="w-8 font-bold text-blue-900 text-lg">e:</span><input type="number" name="e" value={coeffs.e} onChange={handleInputChange} className="w-16 border border-gray-300 rounded p-1 text-center font-bold text-blue-900 ml-1 text-lg"/></div>}
                      </div>
                   </div>
                    <div className="col-span-1"><SocraticTutor funcType={funcType} coeffs={coeffs} analysis={analysis} onToggleResults={() => setShowAnalysis(!showAnalysis)} /></div>
                    
                    {/* --- MỤC 7 MỚI: TƯƠNG GIAO ĐỒ THỊ --- */}
                    <div className="bg-white p-4 rounded-xl shadow border-2 border-orange-200 col-span-1">
                     <label className="block text-lg font-bold mb-3 text-orange-700 flex items-center justify-between" style={{ fontFamily: FONT_FAMILY }}>
                        <div className="flex items-center"><Split className="w-5 h-5 mr-2" /> 7. Bài toán Tương giao</div>
                        <div className="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="toggle" checked={intersection.active} onChange={(e) => setIntersection({...intersection, active: e.target.checked})} className="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label htmlFor="toggle" className={`toggle-label block overflow-hidden h-6 rounded-full cursor-pointer ${intersection.active ? 'bg-orange-500' : 'bg-gray-300'}`}></label>
                        </div>
                     </label>
                     {intersection.active ? (
                         <div className="animate-in fade-in">
                             <div className="flex items-center mb-2">
                                 <span className="font-bold mr-2 text-blue-900">Đường thẳng y = m:</span>
                                 <input type="number" value={intersection.m} onChange={(e) => setIntersection({...intersection, m: e.target.value})} className="border border-orange-300 rounded px-2 py-1 w-20 text-center font-bold text-orange-600"/>
                             </div>
                             <input type="range" min="-10" max="10" step="0.1" value={intersection.m} onChange={(e) => setIntersection({...intersection, m: e.target.value})} className="w-full h-2 bg-orange-200 rounded-lg appearance-none cursor-pointer accent-orange-600"/>
                             <div className="text-xs text-gray-500 mt-1 italic text-center">Kéo thanh trượt để thay đổi giá trị m</div>
                         </div>
                     ) : (
                         <div className="text-sm text-gray-400 italic text-center py-4">Bật công tắc để kích hoạt chế độ tương giao</div>
                     )}
                    </div>

                    <div className="bg-white p-4 rounded-xl shadow border border-gray-300 col-span-1 flex flex-col relative transition-all duration-300">
                     <label className="block text-lg font-bold mb-3 text-blue-900 flex items-center justify-between" style={{ fontFamily: FONT_FAMILY }}><div className="flex items-center"><Info className="w-5 h-5 mr-2" /> 4. Kết quả khảo sát</div><button onClick={() => setShowAnalysis(!showAnalysis)} className="text-gray-500 hover:text-blue-900">{showAnalysis ? <EyeOff className="w-5 h-5"/> : <Eye className="w-5 h-5"/>}</button></label>
                     {showAnalysis ? (<div className="flex-1 overflow-y-auto border border-gray-200 rounded bg-[#F5F5F5] p-3 max-h-[300px] animate-in fade-in slide-in-from-top-2"><AnalysisResults analysis={analysis} funcType={funcType} coeffs={coeffs} /></div>) : (<div className="flex-1 flex flex-col items-center justify-center border border-dashed border-gray-300 rounded bg-gray-50 p-6 text-center"><p className="text-gray-500 italic mb-2">Kết quả đang được ẩn để em tự luyện tập với Socrates.</p><button onClick={() => setShowAnalysis(true)} className="px-3 py-1 bg-white border border-gray-300 rounded text-sm text-blue-900 hover:bg-blue-50 font-bold shadow-sm">Hiện kết quả</button></div>)}
                    </div>
                    <div className="bg-white p-3 rounded-xl shadow border border-gray-300 col-span-1">
                      <label className="block text-base font-bold mb-2 text-blue-900 flex items-center" style={{ fontFamily: FONT_FAMILY }}><Palette className="w-5 h-5 mr-2" /> 5. Tùy Chỉnh</label>
                       <div className="space-y-1 text-sm">
                        <div className="flex justify-between items-center"><span className="font-bold text-blue-900">Cỡ chữ: {config.fontSize}</span><div className="flex gap-1"><button onClick={() => setConfig({...config, fontSize: Math.max(10, config.fontSize - 1)})} className="px-3 bg-gray-200 rounded font-bold hover:bg-gray-300">-</button><button onClick={() => setConfig({...config, fontSize: Math.min(24, config.fontSize + 1)})} className="px-3 bg-gray-200 rounded font-bold hover:bg-gray-300">+</button></div></div>
                        <div className="flex justify-between items-center"><span className="font-bold text-blue-900">Zoom: {Math.round(config.zoom*100)}%</span><div className="flex gap-1"><button onClick={() => setConfig({...config, zoom: Math.max(0.5, config.zoom - 0.1)})} className="px-3 bg-gray-200 rounded font-bold hover:bg-gray-300"><ZoomOut className="w-4 h-4"/></button><button onClick={() => setConfig({...config, zoom: Math.min(3, config.zoom + 0.1)})} className="px-3 bg-gray-200 rounded font-bold hover:bg-gray-300"><ZoomIn className="w-4 h-4"/></button></div></div>
                        <div className="pt-2 border-t mt-1"><div className="mb-1 font-bold text-blue-900">Màu chính:</div><div className="flex gap-1">{COLORS.map(c => <button key={c.hex} onClick={() => setConfig({...config, graphColor: c.hex})} className={`w-6 h-6 rounded-full hover:scale-110 transition-transform ${config.graphColor===c.hex?'ring-2 ring-blue-900 scale-110':''}`} style={{backgroundColor:c.hex}}></button>)}</div></div>
                      </div>
                   </div>
                   <div className="bg-white p-3 rounded-xl shadow border border-gray-300 col-span-1">
                      <label className="block text-base font-bold mb-2 text-blue-900 flex items-center" style={{ fontFamily: FONT_FAMILY }}><Layers className="w-5 h-5 mr-2" /> 6. Lớp Hiển Thị</label>
                      <div className="grid grid-cols-2 gap-2 text-sm">
                          <button onClick={() => toggleLayer('asymptotes')} className={`flex items-center p-2 rounded border transition-colors ${viewConfig.asymptotes ? 'bg-blue-100 border-blue-300 text-blue-900 font-bold' : 'bg-gray-50 border-gray-200 text-gray-500'}`}>{viewConfig.asymptotes ? <CheckCircle2 className="w-4 h-4 mr-2 text-green-600"/> : <XCircle className="w-4 h-4 mr-2"/>} Tiệm cận</button>
                          <button onClick={() => toggleLayer('extrema')} className={`flex items-center p-2 rounded border transition-colors ${viewConfig.extrema ? 'bg-blue-100 border-blue-300 text-blue-900 font-bold' : 'bg-gray-50 border-gray-200 text-gray-500'}`}>{viewConfig.extrema ? <CheckCircle2 className="w-4 h-4 mr-2 text-green-600"/> : <XCircle className="w-4 h-4 mr-2"/>} Cực trị</button>
                          <button onClick={() => toggleLayer('intersections')} className={`flex items-center p-2 rounded border transition-colors ${viewConfig.intersections ? 'bg-blue-100 border-blue-300 text-blue-900 font-bold' : 'bg-gray-50 border-gray-200 text-gray-500'}`}>{viewConfig.intersections ? <CheckCircle2 className="w-4 h-4 mr-2 text-green-600"/> : <XCircle className="w-4 h-4 mr-2"/>} Giao điểm</button>
                          <button onClick={() => toggleLayer('projections')} className={`flex items-center p-2 rounded border transition-colors ${viewConfig.projections ? 'bg-blue-100 border-blue-300 text-blue-900 font-bold' : 'bg-gray-50 border-gray-200 text-gray-500'}`}>{viewConfig.projections ? <ArrowUpRight className="w-4 h-4 mr-2 text-green-600"/> : <XCircle className="w-4 h-4 mr-2"/>} Đường gióng</button>
                          <button onClick={() => toggleLayer('grid')} className={`flex items-center p-2 rounded border transition-colors col-span-2 ${viewConfig.grid ? 'bg-blue-100 border-blue-300 text-blue-900 font-bold' : 'bg-gray-50 border-gray-200 text-gray-500'}`}>{viewConfig.grid ? <Grid className="w-4 h-4 mr-2 text-green-600"/> : <XCircle className="w-4 h-4 mr-2"/>} Lưới & Trục</button>
                      </div>
                   </div>
                  </div>
                  
                  <div className="mt-6 mb-2 p-3 bg-green-50 border border-green-200 rounded-lg flex items-center text-sm text-green-800 shadow-sm animate-pulse">
                      <ShieldCheck className="w-6 h-6 mr-3 text-green-600 flex-shrink-0" />
                      <div>
                          <span className="font-bold block">🔒 Bảo mật & Riêng tư tuyệt đối</span>
                          <span>Ứng dụng chạy hoàn toàn trên máy của bạn (Local). Không thu thập dữ liệu, không gửi thông tin về máy chủ. An toàn cho học sinh.</span>
                      </div>
                  </div>
                  
                  {errorMsg && <div className="mt-5 bg-red-50 p-3 rounded text-base text-red-800 border border-red-200 flex items-center"><AlertTriangle className="w-5 h-5 mr-3"/>{errorMsg}</div>}
                </div>
              </div>
              
              {/* --- CỘT PHẢI: KẾT QUẢ --- */}
              <div className="w-[40%] flex flex-col h-full overflow-y-auto bg-[#F5F5F5] p-4 items-center border-l border-gray-300 relative">
                
                {/* 1. BẢNG XÉT DẤU */}
                <div className={`w-full bg-white rounded-xl shadow-md border-2 border-gray-300 mb-4 overflow-hidden flex-shrink-0 ${isGraphFullscreen ? 'hidden' : ''}`}>
                  <div className="bg-blue-900 text-amber-400 px-4 py-2 font-bold text-lg flex items-center" style={{ fontFamily: FONT_FAMILY }}><span>1. Bảng xét dấu</span></div>
                  <div className="p-2 flex justify-center bg-white overflow-x-auto"><BBT analysis={analysis} funcType={funcType} coeffs={coeffs} config={config} /></div>
                </div>

                {/* 2. ĐỒ THỊ (CÓ FULLSCREEN) */}
                <div className={`bg-white rounded-xl shadow-md border-2 border-gray-300 overflow-hidden flex-shrink-0 transition-all duration-300 ${isGraphFullscreen ? 'fixed inset-0 z-50 flex flex-col w-full h-full rounded-none border-0' : 'w-full'}`}>
                  <div className="bg-blue-900 text-amber-400 px-4 py-2 font-bold text-lg flex items-center justify-between" style={{ fontFamily: FONT_FAMILY }}>
                      <span>2. Đồ thị hàm số</span>
                      <button onClick={() => setIsGraphFullscreen(!isGraphFullscreen)} className="text-white hover:text-amber-300 transition-colors p-1" title={isGraphFullscreen ? "Thu nhỏ" : "Phóng to"}>
                          {isGraphFullscreen ? <Minimize className="w-6 h-6"/> : <Maximize className="w-6 h-6"/>}
                      </button>
                  </div>
                  <div className={`p-2 flex justify-center bg-white relative ${isGraphFullscreen ? 'flex-1 items-center bg-gray-100' : ''}`}>
                      <canvas ref={canvasRef} width={650} height={500} className={`border border-slate-100 shadow-sm rounded bg-white ${isGraphFullscreen ? '' : 'max-w-full h-auto'}`} />
                  </div>
                </div>
                <div className="h-10"></div>
              </div>
            </div>
          );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>